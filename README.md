# Lens ODM Diff

Lens ODM Diff is a library which diffs two snapshot [CDISC ODM][1] files and returns a transactional ODM file which can be used to update a data store based on the first ODM file.

## Rationale

Often data sources provide only a snapshot of the data instead of change sets. Performing a full data load of a data store (data warehouse) is not possible for sufficient large data sets and undesirable if one likes to keep a history (audit log) of all changes. One strategy to obtain a change set from a data source delivering only full snapshots, is to diff the last two snapshots of from that datasource against each other. The resulting diff contains the change set.

The ODM Standard defines two file types: snapshot files and transactional files. The former contains just the data as it is valid at a given point in time where the latter contains an arbitrary set of changes. In transactional files, each data element has a transaction type which annotates the data element either as to insert, update or remove. Using transactional files, the complete history of a data source can be expressed.

This library uses transactional ODM files to express the differences between two snapshots. The ETL (Extract Transform Load) process has the following steps:

1. Extract a snapshot from the data source as ODM file
2. Diff this snapshot with the snapshot from yesterday (or whatever interval one has) and save if as transactional ODM file
3. Load the diff into the target datasource

## Install

To install, just add the following to your project dependencies:

```clojure
[org.clojars.akiel/lens-odm-diff "0.1"]
```

## Usage

Lens ODM diff works on data structures generated by [Lens ODM Parser][2]. After one has parsed the two snapshot files, one can diff them and emit the result.

```clojure
(require '[clojure.data.xml :as xml])
(require '[clojure.java.io :as io])
(require '[lens-odm-parser.core :as p])
(require '[lens-odm-diff.core :as d])

(let [old (-> old-filename io/input-stream xml/parse p/parse-odm-file)
      new (-> new-filename io/input-stream xml/parse p/parse-odm-file)]
  (->> (d/diff-snapshots old new "DIFF-ID")
       (p/unparse-odm-file)
       (xml/sexp-as-element)
       (xml/emit-str)
       (spit diff-filename)))
```

## License

Copyright Â© 2016 Alexander Kiel

Distributed under the Eclipse Public License either version 1.0 or (at
your option) any later version.

[1]: <http://www.cdisc.org/odm>
[2]: <https://github.com/alexanderkiel/lens-odm-parser>
